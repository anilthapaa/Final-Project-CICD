- name: Ensure weather-app directory exists
  file:
    path: /home/{{ ansible_user }}/weather-app
    state: directory
    mode: '0755'

- name: Copy project files to remote server
  synchronize:
    src: "{{ playbook_dir }}/../.."
    dest: /home/{{ ansible_user }}/weather-app
    rsync_opts:
      - "--exclude=node_modules"
      - "--exclude=.git"

- name: Build Docker image for React app
  become: yes
  shell: docker build -t react-nginx-app -f Dockerfile .
  args:
    chdir: /home/{{ ansible_user }}/weather-app/Final_Project_CICD

- name: Stop and remove existing container if running
  become: yes
  shell: |
    docker stop react-app || true
    docker rm react-app || true
  ignore_errors: true

- name: Run Docker container to serve React app via NGINX
  become: yes
  shell: docker run -d -p 80:80 --name react-app react-nginx-app
